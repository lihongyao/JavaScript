# æ¦‚è¿°

æµè§ˆå™¨æŒä¹…åŒ–ï¼ˆPersistent Storageï¼‰ æ˜¯æŒ‡æµè§ˆå™¨å…è®¸ç½‘é¡µåœ¨æœ¬åœ°å­˜å‚¨æ•°æ®ï¼Œå³ä½¿ç”¨æˆ·å…³é—­æµè§ˆå™¨æˆ–é‡å¯è®¾å¤‡åï¼Œæ•°æ®ä»ç„¶å¯ä»¥è¢«ä¿ç•™ã€‚ç›¸æ¯”äºæ™®é€šçš„ **ç¼“å­˜**ï¼ŒæŒä¹…åŒ–å­˜å‚¨çš„æ•°æ®ä¸ä¼šå› ä¸ºé¡µé¢åˆ·æ–°æˆ–ä¼šè¯ç»“æŸè€Œä¸¢å¤±ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤æˆ–å—å­˜å‚¨é™åˆ¶å½±å“ã€‚

æŒä¹…åŒ–å­˜å‚¨çš„æ–¹å¼åŒ…æ‹¬ **LocalStorageã€IndexedDBã€Web SQLã€Cookiesã€Cache Storage** ç­‰ï¼Œå®ƒä»¬ä¸»è¦ç”¨äºå­˜å‚¨ç”¨æˆ·è®¾ç½®ã€ç¦»çº¿æ•°æ®ã€ç½‘é¡µçŠ¶æ€ç­‰ï¼Œä»¥æé«˜ç½‘é¡µæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚

# ç­–ç•¥

## Cookies *

[ğŸ“– å‚è€ƒæŒ‡å— >>](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/cookie)

### Cookie å¯é€‰å±æ€§

- pathï¼šä½œç”¨è·¯å¾„ï¼Œé»˜è®¤ä¸ºå½“å‰æ–‡æ¡£æ‰€åœ¨è·¯å¾„ã€‚
- domainï¼šä½œç”¨åŸŸï¼ŒæŒ‡å®šå¯è®¿é—®è¯¥ Cookie çš„åŸŸåã€‚
- max-ageï¼šæŒ‡å®š Cookie è¿‡æœŸæ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œå¦‚ 1 å¹´ä¸ºï¼š365 * 24 * 60 * 60ã€‚
- expiresï¼šæŒ‡å®š Cookie å…·ä½“è¿‡æœŸæ—¥æœŸã€‚
- secureï¼šä»…å…è®¸åœ¨ HTTPS è¿æ¥ä¸­ä¼ è¾“ã€‚
- HttpOnlyï¼šç¦æ­¢ JavaScript è®¿é—®ï¼Œæå‡å®‰å…¨æ€§ã€‚
- SameSiteï¼šé™åˆ¶ Cookie åœ¨è·¨ç«™è¯·æ±‚ä¸­çš„å‘é€è¡Œä¸ºï¼ˆStrict | Lax | Noneï¼‰ã€‚
- è‡ªå®šä¹‰å±æ€§...

### Cookie vs Session

**ğŸª ä»€ä¹ˆæ˜¯ Cookieï¼Ÿ**

HTTP åè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œè¯·æ±‚å®Œæˆåä¸ä¼šè®°ä½ç”¨æˆ·ä¿¡æ¯ã€‚ä½†åœ¨è´­ç‰©è½¦ã€ç”¨æˆ·ç™»å½•ã€ä¸ªæ€§åŒ–è®¾ç½®ç­‰åœºæ™¯ä¸‹ï¼ŒæœåŠ¡å™¨éœ€è¦è¯†åˆ«ç”¨æˆ·ï¼Œå› æ­¤ **Cookie è¯ç”Ÿ** äº†ã€‚

**Cookie æ˜¯å­˜å‚¨åœ¨ <u>å®¢æˆ·ç«¯</u>ï¼ˆæµè§ˆå™¨ï¼‰çš„å°å‹æ–‡æœ¬æ•°æ®**ï¼ŒæœåŠ¡å™¨å‘é€çš„ Cookie å¯è¢«æµè§ˆå™¨å­˜å‚¨ï¼Œå¹¶åœ¨åç»­è¯·æ±‚æ—¶æºå¸¦å›æœåŠ¡å™¨ï¼Œå®ç°ç”¨æˆ·çŠ¶æ€è·Ÿè¸ªã€‚

> é€šå¸¸ï¼ŒCookieç”¨äºå‘ŠçŸ¥æœåŠ¡ç«¯ä¸¤ä¸ªè¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€æµè§ˆå™¨ï¼Œå¦‚ä¿æŒç”¨æˆ·çš„ç™»å½•çŠ¶æ€ã€‚è¿™æ ·å°±è§£å†³äº†HTTPæ— çŠ¶æ€çš„é—®é¢˜ã€‚

**ğŸ”¹ Cookie ä¸»è¦ç”¨é€”**

- **ä¼šè¯ç®¡ç†**ï¼šè®°å½•ç”¨æˆ·ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦æ•°æ®ç­‰ã€‚
- **ä¸ªæ€§åŒ–**ï¼šå­˜å‚¨ç”¨æˆ·åå¥½ï¼Œå¦‚ä¸»é¢˜è®¾ç½®ã€‚
- **è¿½è¸ªåˆ†æ**ï¼šç”¨äºå¹¿å‘Šã€è®¿é—®ç»Ÿè®¡ç­‰ã€‚

> âš ï¸ **Cookie å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œå®¹æ˜“è¢«ç¯¡æ”¹**ï¼Œå› æ­¤ **æœåŠ¡å™¨åº”æ ¡éªŒ Cookie çœŸå®æ€§**ï¼Œé¿å…ä¿¡æ¯æ³„éœ²ã€‚

ğŸŸï¸ ä»€ä¹ˆæ˜¯ Sessionï¼Ÿ

Session ä»£è¡¨ **æœåŠ¡å™¨ç«¯çš„ä¼šè¯çŠ¶æ€ç®¡ç†**ï¼ŒæœåŠ¡å™¨ä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…å”¯ä¸€ **Session ID**ï¼ˆJSESSIONIDï¼‰ï¼Œå­˜å‚¨åœ¨ Cookie æˆ–è¯·æ±‚å‚æ•°ä¸­ã€‚

ç»´åŸºç™¾ç§‘è¿™æ ·è§£é‡Šé“ï¼š

> *åœ¨è®¡ç®—æœºç§‘å­¦é¢†åŸŸæ¥è¯´ï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œé¢†åŸŸï¼Œä¼šè¯(session)æ˜¯ä¸€ç§æŒä¹…ç½‘ç»œåè®®ï¼Œåœ¨ç”¨æˆ·(æˆ–ç”¨æˆ·ä»£ç†)ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¹‹é—´åˆ›å»ºå…³è”ï¼Œä»è€Œèµ·åˆ°äº¤æ¢æ•°æ®åŒ…çš„ä½œç”¨æœºåˆ¶ï¼Œsessionåœ¨ç½‘ç»œåè®®(ä¾‹å¦‚telnetæˆ–FTP)ä¸­æ˜¯éå¸¸é‡è¦çš„éƒ¨åˆ†ã€‚*

**Session æ•°æ®å­˜å‚¨åœ¨ <u>æœåŠ¡å™¨ç«¯</u>**ï¼Œé€šå¸¸ç”¨äºï¼š

- **ç”¨æˆ·èº«ä»½éªŒè¯**ï¼ˆå¦‚ç™»å½•çŠ¶æ€ï¼‰ã€‚
- **è´­ç‰©è½¦æ•°æ®ç®¡ç†**ã€‚
- **é¿å…å®¢æˆ·ç«¯ç¯¡æ”¹é‡è¦æ•°æ®**ã€‚

å½“åœ¨åº”ç”¨ç¨‹åºçš„Webé¡µä¹‹é—´è·³è½¬æ—¶ï¼Œå­˜å‚¨åœ¨Sessionå¯¹è±¡ä¸­çš„å˜é‡å°†ä¸ä¼šä¸¢å¤±ï¼Œè€Œä¼šåœ¨æ•´ä¸ªç”¨æˆ·ä¼šè¯ä¸­ä¸€ç›´å­˜åœ¨ä¸‹å»ã€‚å½“å®¢æˆ·ç«¯å…³é—­ä¼šè¯ï¼Œæˆ–è€…Sessionè¶…æ—¶å¤±æ•ˆæ—¶ä¼šè¯ç»“æŸã€‚

ç›®å‰å¤§å¤šæ•°çš„åº”ç”¨éƒ½æ˜¯ç”¨Cookieå®ç°Sessionè·Ÿè¸ªçš„ã€‚ç¬¬ä¸€æ¬¡åˆ›å»ºSessionæ—¶ï¼ŒæœåŠ¡ç«¯ä¼šé€šè¿‡åœ¨HTTPåè®®ä¸­è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œåœ¨Cookieä¸­è®°å½•SessionIDï¼Œåç»­è¯·æ±‚æ—¶ä¼ é€’SessionIDç»™æœåŠ¡ï¼Œä»¥ä¾¿åç»­æ¯æ¬¡è¯·æ±‚æ—¶éƒ½å¯åˆ†è¾¨ä½ æ˜¯è°ã€‚

ğŸ”¹ **Cookie vs Session çš„åŒºåˆ«**

| å¯¹æ¯”é¡¹   | Cookie           | Session                  |
| -------- | ---------------- | ------------------------ |
| å­˜å‚¨ä½ç½® | å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ | æœåŠ¡å™¨ç«¯                 |
| å­˜å‚¨æ–¹å¼ | åªèƒ½å­˜å­—ç¬¦ä¸²     | å¯å­˜å‚¨ä»»æ„æ•°æ®           |
| æœ‰æ•ˆæœŸ   | å¯æŒä¹…åŒ–å­˜å‚¨     | ä»…é™ä¼šè¯æœŸï¼ˆå¯é…ç½®è¶…æ—¶ï¼‰ |
| å®‰å…¨æ€§   | æ˜“è¢«ç¯¡æ”¹         | æ›´å®‰å…¨ï¼ˆå­˜å‚¨åœ¨æœåŠ¡å™¨ï¼‰   |
| å­˜å‚¨å¤§å° | 4KB é™åˆ¶         | æ— å›ºå®šå¤§å°é™åˆ¶           |

âŒ **ç¦ç”¨ Cookie è¯¥æ€ä¹ˆåŠï¼Ÿ**

å¦‚æœç”¨æˆ·ç¦ç”¨äº† Cookieï¼Œå¸¸è§è§£å†³æ–¹æ¡ˆæœ‰ï¼š

1ï¸âƒ£ **URL ä¼ é€’ Session ID**ï¼ˆåœ¨è¯·æ±‚å‚æ•°ä¸­æºå¸¦ ?sessionId=xxxxï¼‰ã€‚

æ–¹æ¡ˆä¸€ï¼š**æ‹¼æ¥SessionIdå‚æ•°**ã€‚åœ¨GETæˆ–POSTè¯·æ±‚ä¸­æ‹¼æ¥SessionIDï¼ŒGETè¯·æ±‚é€šå¸¸é€šè¿‡URLåé¢æ‹¼æ¥å‚æ•°æ¥å®ç°ï¼ŒPOSTè¯·æ±‚å¯ä»¥æ”¾åœ¨Bodyä¸­ã€‚æ— è®ºå“ªç§å½¢å¼éƒ½éœ€è¦ä¸æœåŠ¡å™¨è·å–ä¿æŒä¸€è‡´ã€‚

è¿™ç§æ–¹æ¡ˆæ¯”è¾ƒå¸¸è§ï¼Œæ¯”å¦‚è€å¤–çš„ç½‘ç«™ï¼Œç»å¸¸ä¼šæç¤ºæ˜¯å¦å¼€å¯Cookieã€‚å¦‚æœæœªç‚¹åŒæ„æˆ–æˆæƒï¼Œä¼šå‘ç°æµè§ˆå™¨çš„URLè·¯å¾„ä¸­å¾€å¾€æœ‰ â€œ?sessionId=123abcâ€ è¿™æ ·çš„å‚æ•°ã€‚

2ï¸âƒ£ **åŸºäº Token æœºåˆ¶**ï¼ˆå¦‚ JWTï¼‰ï¼Œå®¢æˆ·ç«¯å­˜å‚¨ Token å¹¶åœ¨è¯·æ±‚å¤´æºå¸¦ã€‚

æ–¹æ¡ˆäºŒï¼š**åŸºäºToken(ä»¤ç‰Œ)**ã€‚åœ¨APPåº”ç”¨ä¸­ç»å¸¸ä¼šç”¨åˆ°Tokenæ¥ä¸æœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚Tokenæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå”¯ä¸€çš„å­—ç¬¦ä¸²ï¼Œç™»å½•æˆåŠŸåç”±æœåŠ¡å™¨è¿”å›ï¼Œæ ‡è¯†å®¢æˆ·çš„ä¸´æ—¶æˆæƒï¼Œå®¢æˆ·ç«¯å¯¹å…¶è¿›è¡Œå­˜å‚¨ï¼Œåœ¨åç»­è¯·æ±‚æ—¶ï¼Œé€šå¸¸ä¼šå°†å…¶æ”¾åœ¨HTTPçš„Headerä¸­ä¼ é€’ç»™æœåŠ¡å™¨ï¼Œç”¨äºæœåŠ¡å™¨éªŒè¯è¯·æ±‚ç”¨æˆ·çš„èº«ä»½ã€‚

### åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ Session å…±äº«

åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼Œå¤šä¸ªæœåŠ¡å™¨å¤„ç†åŒä¸€ä¸šåŠ¡ï¼Œå¦‚æœ Session ä»…å­˜å‚¨åœ¨å•ä¸ªæœåŠ¡å™¨ï¼Œå¯èƒ½å¯¼è‡´ **è¯·æ±‚è¢«è·¯ç”±åˆ°ä¸åŒæœåŠ¡å™¨æ—¶ç™»å½•å¤±æ•ˆ**ã€‚

**âœ… è§£å†³æ–¹æ¡ˆ**

1ï¸âƒ£ **è´Ÿè½½å‡è¡¡ç»‘å®š**ï¼šä½¿ç”¨ **Nginx çš„ ip_hash ç­–ç•¥**ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·å§‹ç»ˆè¯·æ±‚åŒä¸€æœåŠ¡å™¨

2ï¸âƒ£ **Session å¤åˆ¶å…±äº«**ï¼šTomcat ç­‰æœåŠ¡å™¨æ”¯æŒ **Session å¤åˆ¶**ï¼Œå¤šä¸ªæœåŠ¡å™¨åŒæ­¥ Session æ•°æ®ã€‚

3ï¸âƒ£ **å…±äº«ç¼“å­˜ï¼ˆæ¨èï¼‰**ï¼š**Redis / Memcached** å­˜å‚¨ Sessionï¼Œå„æœåŠ¡å™¨å¯è®¿é—®åŒä¸€ Session æ•°æ®ï¼Œä¿è¯çŠ¶æ€ä¸€è‡´æ€§ã€‚

> ğŸ“Œ åœ¨ **Spring Boot** é¡¹ç›®ä¸­ï¼Œç»“åˆ Redis å¯ **è½»æ¾å®ç° Session å…±äº«**ã€‚

### åŒæºç­–ç•¥ä¸è·¨åŸŸè¯·æ±‚

**ğŸ”¹ ä»€ä¹ˆæ˜¯åŒæºç­–ç•¥ï¼Ÿ**

**åŒæº** æŒ‡çš„æ˜¯ **åè®®ã€åŸŸåã€ç«¯å£** ä¸‰è€…ç›¸åŒã€‚

| æ˜¯å¦åŒæº   | ç¤ºä¾‹ 1             | ç¤ºä¾‹ 2            | æ˜¯å¦åŒæº |
| ---------- | ------------------ | ----------------- | -------- |
| âœ… åŒæº     | https://a.com      | https://a.com     | âœ… æ˜¯     |
| âŒ ä¸åŒåè®® | http://a.com       | https://a.com     | âŒ å¦     |
| âŒ ä¸åŒç«¯å£ | https://a.com:8080 | https://a.com:443 | âŒ å¦     |
| âŒ ä¸åŒåŸŸå | https://a.com      | https://b.com     | âŒ å¦     |

**ğŸ”¥ ä¸ºä»€ä¹ˆè¦é™åˆ¶è·¨åŸŸï¼Ÿ**

åŒæºç­–ç•¥çš„ä¸»è¦ç›®çš„æ˜¯ **é˜²æ­¢æ¶æ„ç½‘ç«™çªƒå–æ•°æ®**ï¼Œå¦‚æœ Cookie å¯è¢«ä»»æ„ç½‘ç«™è®¿é—®ï¼Œå¯èƒ½ä¼šé€ æˆï¼š

- **ç”¨æˆ·éšç§æ³„éœ²**ï¼ˆå¦‚ç›—å– Cookieï¼Œæ¨¡æ‹Ÿç”¨æˆ·èº«ä»½ï¼‰ã€‚
- **CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰æ”»å‡»**ï¼ˆè¯±å¯¼ç”¨æˆ·æ‰§è¡Œæ¶æ„æ“ä½œï¼‰ã€‚

**ğŸ”¹ å¦‚ä½•è§£å†³è·¨åŸŸé—®é¢˜ï¼Ÿ**

âœ… **æ–¹æ¡ˆ 1ï¼šæœåŠ¡å™¨ç«¯ä»£ç†**ï¼šé€šè¿‡ **Nginx / Node.js ä»£ç†**ï¼Œè®©æœåŠ¡å™¨ä»£æ›¿å‰ç«¯è¯·æ±‚ç›®æ ‡æœåŠ¡å™¨ï¼Œé¿å…è·¨åŸŸé™åˆ¶ã€‚

âœ… **æ–¹æ¡ˆ 2ï¼šJSONPï¼ˆä»…æ”¯æŒ GETï¼‰**ï¼šé€šè¿‡ \<script> æ ‡ç­¾å¼•å…¥è·¨åŸŸæ•°æ®ï¼Œé€‚ç”¨äºæ—©æœŸ API è¯·æ±‚ã€‚

âœ… **æ–¹æ¡ˆ 3ï¼šCORSï¼ˆæ¨èï¼‰**ï¼š**æœåŠ¡å™¨è¿”å› Access-Control-Allow-Origin å¤´**ï¼Œå…è®¸è·¨åŸŸè®¿é—®ã€‚

```js
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: GET, POST
Access-Control-Allow-Credentials: true
```

âš ï¸ CORS å…è®¸çš„è·¨åŸŸè¯·æ±‚å¯é…ç½®ï¼Œä½¿ç”¨æ—¶éœ€ **é¿å…è¿‡åº¦å¼€æ”¾ï¼Œé˜²æ­¢å®‰å…¨é£é™©**ã€‚

### **ğŸ”¥ æ€»ç»“**

| **å¯¹æ¯”é¡¹** | **Cookie**                     | **Session**                      |
| ---------- | ------------------------------ | -------------------------------- |
| å­˜å‚¨ä½ç½®   | å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰               | æœåŠ¡å™¨                           |
| å­˜å‚¨æ•°æ®   | ä»…æ”¯æŒå­—ç¬¦ä¸²                   | å¯å­˜å‚¨ä»»æ„æ•°æ®ï¼ˆå¯¹è±¡ã€å­—ç¬¦ä¸²ç­‰ï¼‰ |
| ç”Ÿå‘½å‘¨æœŸ   | è®¾å®š max-age / expires         | é»˜è®¤æµè§ˆå™¨å…³é—­å³å¤±æ•ˆ             |
| å­˜å‚¨å¤§å°   | 4KB ä»¥å†…                       | æœåŠ¡å™¨å†³å®š                       |
| å®‰å…¨æ€§     | å®¹æ˜“è¢«çªƒå–å’Œç¯¡æ”¹               | æ›´å®‰å…¨ï¼ŒæœåŠ¡å™¨ç®¡ç†               |
| è·¨åŸŸå½±å“   | å—åŒæºç­–ç•¥å½±å“                 | å¯åœ¨æœåŠ¡å™¨ç«¯å…±äº«                 |
| æœåŠ¡å™¨å‹åŠ› | æœåŠ¡å™¨æ— å‹åŠ›ï¼Œå­˜å‚¨åœ¨å®¢æˆ·ç«¯     | éœ€è¦å ç”¨æœåŠ¡å™¨å­˜å‚¨ç©ºé—´           |
| é€‚ç”¨åœºæ™¯   | é€‚åˆå­˜å‚¨ç”¨æˆ·åå¥½ã€ä¸ªæ€§åŒ–è®¾ç½®ç­‰ | é€‚åˆå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·ç™»å½•çŠ¶æ€ |

> ğŸ“Œ **å»ºè®®**ï¼šç™»å½•çŠ¶æ€æ¨èä½¿ç”¨ **Session + Tokenï¼ˆJWTï¼‰**ï¼Œé¿å…ç›´æ¥ä¾èµ– Cookieã€‚

## Web Storage  *

### æ¦‚è¿°

Web Storage æ˜¯ HTML5 æä¾›çš„ä¸€ç§æœ¬åœ°å­˜å‚¨æœºåˆ¶ï¼Œç›¸è¾ƒäºä¼ ç»Ÿçš„ Cookieï¼Œå®ƒå…·å¤‡æ›´å¤§çš„å­˜å‚¨ç©ºé—´ï¼Œä¸”ä¸ä¼šéšè¯·æ±‚å‘é€è‡³æœåŠ¡å™¨ï¼Œæé«˜äº†æ€§èƒ½å’Œå®‰å…¨æ€§ã€‚Web Storage ä¸»è¦åŒ…å« **ä¼šè¯å­˜å‚¨ (sessionStorage)** å’Œ **æœ¬åœ°å­˜å‚¨ (localStorage)**ï¼Œå®ƒä»¬çš„æ ¸å¿ƒç‰¹æ€§å¦‚ä¸‹ï¼š

- **åŸºäºé”®å€¼å¯¹å­˜å‚¨**ï¼Œä½¿ç”¨æ–¹å¼ç±»ä¼¼ JavaScript å¯¹è±¡ (key-value å½¢å¼)ã€‚
- **ä¸ä¼šéš HTTP è¯·æ±‚å‘é€**ï¼Œå‡å°‘äº†ç½‘ç»œä¼ è¾“è´Ÿæ‹…ã€‚
- **æ”¯æŒæ›´å¤§çš„å­˜å‚¨å®¹é‡**ï¼ˆä¸€èˆ¬ä¸º 5MB æˆ–ä»¥ä¸Šï¼‰ï¼Œç›¸æ¯”äº Cookie çš„ 4KB é™åˆ¶æ›´ä¸ºçµæ´»ã€‚
- **æ“ä½œç®€å•**ï¼Œæä¾›äº† setItemã€getItemã€removeItemã€clear ç­‰æ–¹æ³•ã€‚1

### æœ¬åœ°å­˜å‚¨ Vs ä¼šè¯å­˜å‚¨

| å­˜å‚¨æ–¹å¼ | sessionStorageï¼ˆä¼šè¯å­˜å‚¨ï¼‰     | localStorageï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰       |
| -------- | ------------------------------ | ------------------------------ |
| å­˜å‚¨å‘¨æœŸ | ä»…åœ¨å½“å‰ä¼šè¯ï¼ˆé¡µé¢å…³é—­å³æ¸…é™¤ï¼‰ | æŒä¹…å­˜å‚¨ï¼Œé™¤éæ‰‹åŠ¨åˆ é™¤         |
| ä½œç”¨èŒƒå›´ | ä»…é™å½“å‰é¡µé¢æˆ–æ ‡ç­¾é¡µ           | è·¨é¡µé¢ã€è·¨çª—å£å¯ç”¨             |
| æ•°æ®å¤§å° | é€šå¸¸ 5MB                       | é€šå¸¸ 5MB                       |
| æ•°æ®å…±äº« | åŒæºä¸‹çš„åŒä¸€çª—å£å¯è®¿é—®         | åŒæºä¸‹çš„æ‰€æœ‰çª—å£å‡å¯è®¿é—®       |
| åº”ç”¨åœºæ™¯ | çŸ­æš‚æ•°æ®å­˜å‚¨ï¼ˆå¦‚è¡¨å•å¡«å†™çŠ¶æ€ï¼‰ | é•¿æœŸæ•°æ®å­˜å‚¨ï¼ˆå¦‚ç”¨æˆ·åå¥½è®¾ç½®ï¼‰ |

### å¸¸ç”¨ API æ–¹æ³•

```js
// å­˜å‚¨æ•°æ®
localStorage.setItem("name", "å¼ ä¸‰");
sessionStorage.setItem("sessionKey", "ä¸´æ—¶æ•°æ®");

// è¯»å–æ•°æ®
console.log(localStorage.getItem("name")); // "å¼ ä¸‰"
console.log(sessionStorage.getItem("sessionKey")); // "ä¸´æ—¶æ•°æ®"

// åˆ é™¤æ•°æ®
localStorage.removeItem("name");
sessionStorage.removeItem("sessionKey");

// æ¸…ç©ºå­˜å‚¨
localStorage.clear();
sessionStorage.clear();
```

> æç¤ºï¼š
>
> 1. localStorage æ•°æ®ä¼šæŒä¹…åŒ–å­˜å‚¨ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤æˆ–ä»£ç åˆ é™¤ã€‚
>2. åœ¨æµè§ˆå™¨çš„ **å¼€å‘è€…å·¥å…· â†’ Application â†’ Storage** ä¸­å¯æŸ¥çœ‹ Web Storage æ•°æ®ã€‚

### å­˜å‚¨å¯¹è±¡æ•°æ®

Web Storage åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼Œè‹¥è¦å­˜å‚¨å¯¹è±¡æ•°æ®ï¼Œå¯å€ŸåŠ© JSON.stringify() è½¬æ¢ï¼Œè¯»å–æ—¶ç”¨ JSON.parse() è§£æã€‚

```js
// -- å­˜å‚¨å¯¹è±¡æ•°æ®
const user = { name: "å¼ ä¸‰", age: 30, major: "è½¯ä»¶å·¥ç¨‹" };
localStorage.setItem("user", JSON.stringify(user));

// -- è¯»å–å¯¹è±¡æ•°æ®
const storedUser = JSON.parse(localStorage.getItem("user"));
console.log(storedUser.name); // "å¼ ä¸‰"
```

### Web Storage Vs Cookie

1. **æ¯” Cookie æ›´å®‰å…¨**ï¼šä¸ä¼šéšè¯·æ±‚å‘é€ï¼Œå‡å°‘äº†æ³„éœ²é£é™©ã€‚
2. **å­˜å‚¨å®¹é‡æ›´å¤§**ï¼šæ”¯æŒ 5MB åŠä»¥ä¸Šï¼Œè€Œ Cookie ä»… 4KBã€‚
3. **æ“ä½œæ›´ç®€å•**ï¼šæ— éœ€æ¶‰åŠå¤æ‚çš„ HTTP å¤´æ“ä½œï¼ŒAPI ç›´æ¥å­˜å–ã€‚

## Web-SQL

[å‚è€ƒ >>](https://www.runoob.com/html/html5-web-sql.html)

## IndexedDB

[å‚è€ƒ >>](https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API)

### æ¦‚è¿°

IndexedDB æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ªä½çº§ APIï¼Œç”¨äºåœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸­å­˜å‚¨å¤§é‡ç»“æ„åŒ–æ•°æ®ã€‚å®ƒæ”¯æŒäº‹åŠ¡ã€ç´¢å¼•å’ŒæŸ¥è¯¢æ“ä½œï¼Œæ˜¯å‰ç«¯æŒä¹…åŒ–å­˜å‚¨çš„é‡è¦å·¥å…·ä¹‹ä¸€ã€‚

### ç‰¹ç‚¹

1. **å­˜å‚¨é‡å¤§**

   IndexedDB çš„å­˜å‚¨å®¹é‡æ¯”ä¼ ç»Ÿçš„`localStorage`å¤§å¾—å¤šã€‚`localStorage`ä¸€èˆ¬æœ‰ 5MB å·¦å³çš„å­˜å‚¨é™åˆ¶ï¼ˆå…·ä½“å› æµè§ˆå™¨è€Œå¼‚ï¼‰ï¼Œè€Œ IndexedDB çš„å­˜å‚¨å®¹é‡å¯ä»¥è¾¾åˆ°å‡ ç™¾ MB ç”šè‡³æ›´å¤šï¼Œè¿™ä½¿å¾—å®ƒèƒ½å¤Ÿå­˜å‚¨å¤§é‡çš„æ•°æ®ï¼Œå¦‚å¤§å‹æ–‡æ¡£ã€å›¾åƒæ•°æ®çš„ç¼“å­˜æˆ–è€…å¤æ‚çš„åº”ç”¨ç¨‹åºæ•°æ®ã€‚

2. **å¼‚æ­¥æ“ä½œ**

   IndexedDB æ˜¯å¼‚æ­¥çš„ APIã€‚è¿™æ„å‘³ç€å®ƒä¸ä¼šé˜»å¡æµè§ˆå™¨çš„ä¸»çº¿ç¨‹ï¼Œåœ¨è¿›è¡Œæ•°æ®åº“æ“ä½œï¼ˆå¦‚æ‰“å¼€æ•°æ®åº“ã€æ·»åŠ ã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤æ•°æ®ç­‰ï¼‰æ—¶ï¼Œæµè§ˆå™¨å¯ä»¥ç»§ç»­å“åº”ç”¨æˆ·çš„å…¶ä»–æ“ä½œï¼Œå¦‚æ»šåŠ¨é¡µé¢ã€ç‚¹å‡»æŒ‰é’®ç­‰ã€‚ä¾‹å¦‚ï¼Œå½“æ‰§è¡Œä¸€ä¸ªå¤æ‚çš„æŸ¥è¯¢æ“ä½œæ¥è·å–å¤§é‡æ•°æ®æ—¶ï¼Œç”¨æˆ·ä»ç„¶å¯ä»¥ä¸é¡µé¢è¿›è¡Œäº¤äº’ï¼Œä¸ä¼šå‡ºç°é¡µé¢å¡é¡¿çš„æƒ…å†µã€‚

3. **æ”¯æŒäº‹åŠ¡ï¼ˆTransactionsï¼‰**

   IndexedDB ä½¿ç”¨äº‹åŠ¡æ¥ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ã€‚äº‹åŠ¡å¯ä»¥å°†ä¸€ç³»åˆ—çš„æ•°æ®åº“æ“ä½œï¼ˆå¦‚å¤šä¸ªæ·»åŠ ã€æ›´æ–°æ“ä½œï¼‰åŒ…è£¹èµ·æ¥ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸæ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªè´¢åŠ¡åº”ç”¨ç¨‹åºä¸­ï¼Œå½“è¿›è¡Œè½¬è´¦æ“ä½œæ—¶ï¼Œéœ€è¦ä»ä¸€ä¸ªè´¦æˆ·æ‰£é™¤é‡‘é¢å¹¶æ·»åŠ åˆ°å¦ä¸€ä¸ªè´¦æˆ·ï¼Œè¿™ä¸¤ä¸ªæ“ä½œåº”è¯¥ä½œä¸ºä¸€ä¸ªäº‹åŠ¡æ¥å¤„ç†ï¼Œä»¥é¿å…å‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚

   äº‹åŠ¡æœ‰ä¸åŒçš„æ¨¡å¼ï¼ŒåŒ…æ‹¬`readonly`ï¼ˆåªè¯»ï¼‰ã€`readwrite`ï¼ˆå¯è¯»å¯å†™ï¼‰å’Œ`versionchange`ï¼ˆç”¨äºæ•°æ®åº“ç‰ˆæœ¬æ›´æ–°ï¼‰ã€‚ä¾‹å¦‚ï¼Œåœ¨åªè¯»äº‹åŠ¡ä¸­ï¼Œä¸èƒ½è¿›è¡Œæ•°æ®çš„æ·»åŠ ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œï¼›è€Œåœ¨å¯è¯»å¯å†™äº‹åŠ¡ä¸­ï¼Œå¯ä»¥è¿›è¡Œå„ç§æ•°æ®æ“ä½œã€‚

4. **æ”¯æŒå¤æ‚çš„æ•°æ®æŸ¥è¯¢å’Œç´¢å¼•ï¼ˆIndexesï¼‰**

   å¯ä»¥åœ¨å¯¹è±¡å­˜å‚¨ç©ºé—´ä¸­åˆ›å»ºç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°æŸ¥è¯¢æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªå­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„ IndexedDB æ•°æ®åº“ä¸­ï¼Œå¦‚æœç»å¸¸éœ€è¦æ ¹æ®ç”¨æˆ·çš„å§“åæ¥æŸ¥è¯¢ç”¨æˆ·è®°å½•ï¼Œå¯ä»¥ä¸ºå§“åå±æ€§åˆ›å»ºä¸€ä¸ªç´¢å¼•ã€‚

5. **æ”¯æŒç»“æ„åŒ–å­˜å‚¨**

   IndexedDB å…è®¸å­˜å‚¨å¤æ‚çš„ JavaScript å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å¯ä»¥æœ‰åµŒå¥—çš„å±æ€§å’Œæ•°ç»„ç­‰ç»“æ„ã€‚ä¸`localStorage`åªèƒ½å­˜å‚¨ç®€å•çš„é”®å€¼å¯¹ï¼ˆå­—ç¬¦ä¸²ç±»å‹ï¼‰ä¸åŒï¼ŒIndexedDB å¯ä»¥å­˜å‚¨åƒåŒ…å«å¤šä¸ªç”¨æˆ·ä¿¡æ¯ï¼ˆæ¯ä¸ªç”¨æˆ·ä¿¡æ¯åˆåŒ…å«å§“åã€å¹´é¾„ã€åœ°å€ç­‰å±æ€§ï¼‰è¿™æ ·çš„å¤æ‚æ•°æ®ç»“æ„ã€‚

6. **æŒä¹…æ€§ï¼ˆPersistenceï¼‰**

   IndexedDB çš„æ•°æ®å¯ä»¥è®¾ç½®ä¸ºæŒä¹…åŒ–å­˜å‚¨ï¼Œè¿™æ„å‘³ç€å³ä½¿ç”¨æˆ·å…³é—­æµè§ˆå™¨æˆ–è€…è®¡ç®—æœºé‡æ–°å¯åŠ¨ï¼Œæ•°æ®ä»ç„¶å¯ä»¥ä¿ç•™ã€‚è¿™å¯¹äºéœ€è¦é•¿æœŸä¿å­˜æ•°æ®çš„åº”ç”¨ç¨‹åºéå¸¸é‡è¦ï¼Œå¦‚ Web åº”ç”¨ä¸­çš„ç¦»çº¿æ•°æ®å­˜å‚¨æˆ–è€…éœ€è¦åœ¨å¤šæ¬¡ä¼šè¯ä¹‹é—´ä¿å­˜ç”¨æˆ·çŠ¶æ€çš„åº”ç”¨ã€‚ä¸è¿‡ï¼Œæµè§ˆå™¨å¯¹ IndexedDB æ•°æ®çš„æŒä¹…åŒ–ç®¡ç†ä¹Ÿæœ‰ä¸€å®šçš„ç­–ç•¥ï¼Œä»¥å¹³è¡¡å­˜å‚¨èµ„æºå’Œç”¨æˆ·ä½“éªŒã€‚


### ä¼˜ç¼ºç‚¹

**ğŸ”µ ä¼˜ç‚¹**

1. æ”¯æŒå­˜å‚¨å¤§è§„æ¨¡æ•°æ®ï¼ˆæœ€å¤§å¯è¾¾ 50MB ç”šè‡³æ›´å¤šï¼‰ã€‚
2. æ”¯æŒäº‹åŠ¡ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚
3. æœ¬åœ°å­˜å‚¨ï¼Œç”¨æˆ·ç¦»çº¿æ—¶ä»å¯ä½¿ç”¨ã€‚

**ğŸ”µ ç¼ºç‚¹**

1. æ“ä½œè¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦å¤„ç†å¼‚æ­¥é€»è¾‘ã€‚
2. ä¸æ”¯æŒç›´æ¥è·¨åŸŸæ“ä½œã€‚

### æ ¸å¿ƒæ¦‚å¿µ

1. **æ•°æ®åº“ï¼ˆDatabaseï¼‰**

   æ¯ä¸ª IndexedDB æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥å­˜å‚¨å¤šä¸ªå¯¹è±¡å­˜å‚¨ï¼ˆç±»ä¼¼å…³ç³»å‹æ•°æ®åº“çš„è¡¨ï¼‰ã€‚

2. **å¯¹è±¡å­˜å‚¨ï¼ˆObject Storeï¼‰**

   å¯¹è±¡å­˜å‚¨æ˜¯æ•°æ®åº“çš„æ ¸å¿ƒï¼Œç”¨äºå­˜å‚¨æ•°æ®è®°å½•ï¼ˆç±»ä¼¼å…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ï¼‰ã€‚

3. **äº‹åŠ¡ï¼ˆTransactionï¼‰**

   æ•°æ®åº“æ“ä½œéœ€è¦é€šè¿‡äº‹åŠ¡å®Œæˆï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

4. **ç´¢å¼•ï¼ˆIndexï¼‰**

   ç´¢å¼•å¯ä»¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Œç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“çš„ç´¢å¼•ã€‚

5. **ä¸»é”®ï¼ˆKeyï¼‰**

   ä¸»é”®ç”¨äºå”¯ä¸€æ ‡è¯†æ¯æ¡è®°å½•ï¼Œå¯ä»¥æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„é”®ï¼Œä¹Ÿå¯ä»¥æ˜¯æ‰‹åŠ¨æŒ‡å®šçš„å€¼ã€‚

### API

ä»¥ä¸‹æ˜¯ IndexedDB API çš„æ ¸å¿ƒå¯¹è±¡åŠå…¶ç”¨é€”çš„ç®€è¦è¯´æ˜ï¼š

#### indexedDB

å…¨å±€å¯¹è±¡ï¼Œç”¨äºæ“ä½œæ•°æ®åº“

- `indexedDB.open(name, version)`: æ‰“å¼€/åˆ›å»ºæ•°æ®åº“ã€‚
- `db.close()`: å…³é—­æ•°æ®åº“ã€‚
- `db.deleteDatabase(name)`: åˆ é™¤æ•°æ®åº“ã€‚

#### IDBDatabaseï¼ˆæ•°æ®åº“å¯¹è±¡ï¼‰

è¡¨ç¤ºå·²æ‰“å¼€çš„æ•°æ®åº“å®ä¾‹ï¼Œç”¨äºç®¡ç†æ•°æ®åº“çš„æ‰€æœ‰æ“ä½œã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

- åˆ›å»ºå’Œåˆ é™¤å¯¹è±¡å­˜å‚¨ï¼ˆObject Storeï¼‰ã€‚
- å¯åŠ¨äº‹åŠ¡ï¼ˆTransactionï¼‰ã€‚
- ä¾›æ•°æ®åº“çš„å…ƒä¿¡æ¯ï¼ˆå¦‚åç§°ã€ç‰ˆæœ¬ã€å¯¹è±¡å­˜å‚¨åˆ—è¡¨ç­‰ï¼‰ã€‚

**å¸¸ç”¨æ–¹æ³•ï¼š**

- `createObjectStore(name, options)`: åˆ›å»ºå¯¹è±¡å­˜å‚¨ã€‚
- `deleteObjectStore(name)`: åˆ é™¤å¯¹è±¡å­˜å‚¨ã€‚
- `transaction(storeNames, mode)`: åˆ›å»ºäº‹åŠ¡ã€‚

#### IDBObjectStoreï¼ˆå¯¹è±¡å­˜å‚¨/è¡¨ï¼‰

è¡¨ç¤ºæ•°æ®åº“ä¸­çš„ä¸€ä¸ªå­˜å‚¨è¡¨ï¼Œç”¨äºå­˜å‚¨å’Œæ“ä½œæ•°æ®ã€‚

æ¯ä¸ªå¯¹è±¡å­˜å‚¨ç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ï¼Œä½†åªèƒ½å­˜å‚¨é”®å€¼å¯¹å½¢å¼çš„æ•°æ®ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

- æ•°æ®çš„å¢åˆ æ”¹æŸ¥ã€‚
- ç®¡ç†ç´¢å¼•ã€‚

**å¸¸ç”¨æ–¹æ³•ï¼š**

- `add(value, key)`: æ·»åŠ æ•°æ®ï¼ˆå¦‚æœä¸»é”®å·²å­˜åœ¨åˆ™æŠ¥é”™ï¼‰ã€‚
- `put(value, key)`: æ·»åŠ æˆ–æ›´æ–°æ•°æ®ã€‚
- `get(key)`: æ ¹æ®ä¸»é”®è·å–æ•°æ®ã€‚
- `delete(key)`: åˆ é™¤æŒ‡å®šä¸»é”®çš„æ•°æ®ã€‚
- `clear()`: æ¸…ç©ºè¡¨ä¸­æ‰€æœ‰æ•°æ®ã€‚
- `openCursor()`: éå†è¡¨ä¸­çš„æ•°æ®ã€‚
- `createIndex(name, keyPath, options)`: åˆ›å»ºç´¢å¼•ã€‚

#### IDBIndexï¼ˆç´¢å¼•ï¼‰

è¡¨ç¤ºå¯¹è±¡å­˜å‚¨ä¸­çš„ä¸€ä¸ªç´¢å¼•ï¼Œç”¨äºåŠ é€Ÿæ•°æ®æŸ¥è¯¢ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

- åŸºäºç´¢å¼•å­—æ®µé«˜æ•ˆæŸ¥è¯¢æ•°æ®ã€‚

**å¸¸ç”¨æ–¹æ³•ï¼š**

- `get(key)`: æ ¹æ®ç´¢å¼•å€¼æŸ¥è¯¢å•æ¡è®°å½•ã€‚
- `getAll(key)`: æŸ¥è¯¢æ‰€æœ‰åŒ¹é…çš„æ•°æ®ï¼ˆéƒ¨åˆ†æµè§ˆå™¨æ”¯æŒï¼‰ã€‚
- `openCursor()`: éå†åŸºäºç´¢å¼•çš„æ•°æ®ã€‚
- `count(key)`: ç»Ÿè®¡åŸºäºç´¢å¼•çš„è®°å½•æ•°é‡ã€‚

#### IDBTransactionï¼ˆäº‹åŠ¡ï¼‰

ç”¨äºç®¡ç†å¯¹è±¡å­˜å‚¨å’Œç´¢å¼•çš„æ“ä½œï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

- å°†å¤šä¸ªæ•°æ®åº“æ“ä½œç»‘å®šåœ¨ä¸€èµ·ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼ˆåŸå­æ€§ï¼‰ã€‚

**å±æ€§ï¼š**

- `db`: äº‹åŠ¡å…³è”çš„æ•°æ®åº“å¯¹è±¡ã€‚
- `mode`: äº‹åŠ¡æ¨¡å¼ï¼ˆ`readonly` æˆ– `readwrite`ï¼‰ã€‚
- `objectStore(name)`: è·å–äº‹åŠ¡ä¸­çš„å¯¹è±¡å­˜å‚¨ã€‚

**äº‹ä»¶ï¼š**

- `oncomplete`: äº‹åŠ¡æˆåŠŸå®Œæˆæ—¶è§¦å‘ã€‚
- `onerror`: äº‹åŠ¡å¤±è´¥æ—¶è§¦å‘ã€‚

#### IDBRequestï¼ˆè¯·æ±‚å¯¹è±¡ï¼‰

è¡¨ç¤ºä¸€æ¬¡å¼‚æ­¥æ•°æ®åº“æ“ä½œï¼ˆå¦‚æ·»åŠ ã€æŸ¥è¯¢ã€åˆ é™¤ï¼‰çš„è¯·æ±‚ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

- è·Ÿè¸ªå¼‚æ­¥æ“ä½œçš„çŠ¶æ€ï¼ˆ`success` æˆ– `error`ï¼‰ã€‚

**å±æ€§ï¼š**

- `result`: æ“ä½œæˆåŠŸæ—¶è¿”å›çš„æ•°æ®ç»“æœã€‚
- `error`: æ“ä½œå¤±è´¥æ—¶è¿”å›çš„é”™è¯¯ä¿¡æ¯ã€‚

**äº‹ä»¶ï¼š**

- `onsuccess`: æ“ä½œæˆåŠŸæ—¶è§¦å‘ã€‚
- `onerror`: æ“ä½œå¤±è´¥æ—¶è§¦å‘ã€‚

#### IDBCursorï¼ˆæ¸¸æ ‡ï¼‰

ç”¨äºéå†å¯¹è±¡å­˜å‚¨æˆ–ç´¢å¼•ä¸­çš„æ•°æ®ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

- éå†è¡¨ä¸­çš„æ‰€æœ‰è®°å½•æˆ–æŒ‡å®šèŒƒå›´çš„è®°å½•ã€‚

**å¸¸ç”¨æ–¹æ³•ï¼š**

- `continue()`: ç§»åŠ¨åˆ°ä¸‹ä¸€æ¡è®°å½•ã€‚
- `delete()`: åˆ é™¤å½“å‰è®°å½•ã€‚
- `update(value)`: æ›´æ–°å½“å‰è®°å½•ã€‚

#### IDBKeyRangeï¼ˆé”®èŒƒå›´ï¼‰

ç”¨äºå®šä¹‰æŸ¥è¯¢æˆ–éå†çš„é”®èŒƒå›´ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

- æŒ‡å®šèŒƒå›´ï¼ˆå¦‚å°äºã€å¤§äºã€åŒºé—´ï¼‰æ¥è¿‡æ»¤æ•°æ®ã€‚

**å¸¸ç”¨æ–¹æ³•ï¼š**

- `bound(lower, upper, lowerOpen?, upperOpen?)`: åˆ›å»ºä¸€ä¸ªåŒºé—´èŒƒå›´ã€‚
- `only(value)`: ç²¾ç¡®åŒ¹é…æŸä¸ªé”®ã€‚
- `lowerBound(value, open?)`: å¤§äºæˆ–å¤§äºç­‰äºæŸä¸ªé”®ã€‚
- `upperBound(value, open?)`: å°äºæˆ–å°äºç­‰äºæŸä¸ªé”®ã€‚

æ€»ç»“ï¼š

| å¯¹è±¡               | ä½œç”¨                             | å¸¸ç”¨æ–¹æ³•/åŠŸèƒ½                               |
| ------------------ | -------------------------------- | ------------------------------------------- |
| **IDBDatabase**    | ç®¡ç†æ•°æ®åº“å’Œå¯¹è±¡å­˜å‚¨             | `createObjectStore`, `transaction`          |
| **IDBObjectStore** | æ•°æ®çš„å¢åˆ æ”¹æŸ¥å’Œéå†             | `add`, `put`, `get`, `openCursor`           |
| **IDBIndex**       | ç´¢å¼•ç®¡ç†ä¸é«˜æ•ˆæŸ¥è¯¢               | `get`, `openCursor`, `count`                |
| **IDBTransaction** | ç®¡ç†æ•°æ®æ“ä½œçš„ä¸€è‡´æ€§ï¼Œä¿è¯åŸå­æ€§ | `objectStore`, `oncomplete`, `onerror`      |
| **IDBRequest**     | è·Ÿè¸ªå¼‚æ­¥æ“ä½œçŠ¶æ€ï¼ˆå¦‚æˆåŠŸ/å¤±è´¥ï¼‰  | `onsuccess`, `onerror`                      |
| **IDBCursor**      | éå†å¯¹è±¡å­˜å‚¨æˆ–ç´¢å¼•çš„æ•°æ®         | `continue`, `delete`, `update`              |
| **IDBKeyRange**    | å®šä¹‰é”®èŒƒå›´ä»¥è¿‡æ»¤æŸ¥è¯¢ç»“æœ         | `bound`, `only`, `lowerBound`, `upperBound` |

è¿™äº›å¯¹è±¡é…åˆä½¿ç”¨ï¼Œå¯ä»¥å®ç°å¤æ‚çš„æœ¬åœ°å­˜å‚¨å’ŒæŸ¥è¯¢åŠŸèƒ½ã€‚

### å·¥ä½œæµ

#### æ‰“å¼€æ•°æ®åº“

ä½¿ç”¨ indexedDB.open æ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå¦‚æœæŒ‡å®šçš„æ•°æ®åº“ä¸å­˜åœ¨ï¼Œå°±ä¼šæ–°å»ºã€‚

è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªè¯·æ±‚å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡æ¥å¤„ç†æ•°æ®åº“æ“ä½œç»“æœã€‚æˆåŠŸæ‰“å¼€æ•°æ®åº“åï¼Œä¼šå¾—åˆ°ä¸€ä¸ª `IDBDatabase` å¯¹è±¡ï¼Œå®ƒä»£è¡¨æ•´ä¸ªæ•°æ®åº“ã€‚

```js
const request = indexedDB.open('MyDatabase', 1);

request.onsuccess = function (event) {
  const db = event.target.result; // è·å–æ•°æ®åº“å®ä¾‹
  console.log('æ•°æ®åº“å·²æ‰“å¼€', db);
};

request.onerror = function (event) {
  console.error('æ•°æ®åº“æ‰“å¼€å¤±è´¥', event.target.error);
};

request.onupgradeneeded = function (event) {
  const db = event.target.result;
  console.log('æ•°æ®åº“å‡çº§æˆ–é¦–æ¬¡åˆ›å»º');

  // åˆ›å»ºå¯¹è±¡å­˜å‚¨
  if (!db.objectStoreNames.contains('users')) {
    db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
  }
};
```

> æç¤ºï¼šä½ å¯ä»¥åœ¨ **è°ƒå¼å·¥å…· â€” åº”ç”¨ â€” å­˜å‚¨/IndexDB** æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯ã€‚

#### åˆ›å»ºå¯¹è±¡å­˜å‚¨ï¼ˆè¡¨ï¼‰å’Œ ç´¢å¼•

åœ¨ onupgradeneeded ä¸­åˆ›å»ºå¯¹è±¡å­˜å‚¨ï¼š

```js
const objectStore = db.createObjectStore('users', {
  keyPath: 'id', // ä¸»é”®
  autoIncrement: true, // è‡ªåŠ¨é€’å¢
});

// åˆ›å»ºç´¢å¼•
objectStore.createIndex('name', 'name', { unique: false });
objectStore.createIndex('email', 'email', { unique: true });
```

#### æ·»åŠ æ•°æ®

ä½¿ç”¨äº‹åŠ¡å’Œå¯¹è±¡å­˜å‚¨çš„ add æ–¹æ³•æ’å…¥æ•°æ®ï¼š

```javascript
const transaction = db.transaction(['users'], 'readwrite');
const objectStore = transaction.objectStore('users');

const request = objectStore.add({ name: 'Alice', email: 'alice@example.com' });

request.onsuccess = function () {
  console.log('æ•°æ®æ·»åŠ æˆåŠŸ');
};

request.onerror = function (event) {
  console.error('æ•°æ®æ·»åŠ å¤±è´¥', event.target.error);
};
```

#### è·å–æ•°æ®

**é€šè¿‡ä¸»é”®è·å–æ•°æ®**

```javascript
const transaction = db.transaction(['users']);
const objectStore = transaction.objectStore('users');

const request = objectStore.get(1); // æŸ¥è¯¢ä¸»é”®ä¸º 1 çš„æ•°æ®

request.onsuccess = function (event) {
  console.log('æŸ¥è¯¢æˆåŠŸï¼š', event.target.result);
};

request.onerror = function (event) {
  console.error('æŸ¥è¯¢å¤±è´¥', event.target.error);
};
```

**é€šè¿‡ç´¢å¼•è·å–æ•°æ®**

```js
const transaction = db.transaction(['users']);
const objectStore = transaction.objectStore('users');
const index = objectStore.index('email'); // ä½¿ç”¨ç´¢å¼•

const request = index.get('alice@example.com'); // æŸ¥è¯¢ email ä¸º 'alice@example.com' çš„æ•°æ®

request.onsuccess = function (event) {
  console.log('æŸ¥è¯¢æˆåŠŸï¼š', event.target.result);
};

request.onerror = function (event) {
  console.error('æŸ¥è¯¢å¤±è´¥', event.target.error);
};
```

#### æ›´æ–°æ•°æ®

ä½¿ç”¨ put æ–¹æ³•æ›´æ–°æ•°æ®ï¼š

```js
const transaction = db.transaction(['users'], 'readwrite');
const objectStore = transaction.objectStore('users');

const request = objectStore.put({ id: 1, name: 'Alice', email: 'alice@new.com' });

request.onsuccess = function () {
  console.log('æ•°æ®æ›´æ–°æˆåŠŸ');
};

request.onerror = function (event) {
  console.error('æ•°æ®æ›´æ–°å¤±è´¥', event.target.error);
};
```

#### åˆ é™¤æ•°æ®

ä½¿ç”¨ delete æ–¹æ³•åˆ é™¤è®°å½•ï¼š

```js
const transaction = db.transaction(['users'], 'readwrite');
const objectStore = transaction.objectStore('users');

const request = objectStore.delete(1); // åˆ é™¤ä¸»é”®ä¸º 1 çš„æ•°æ®

request.onsuccess = function () {
  console.log('æ•°æ®åˆ é™¤æˆåŠŸ');
};

request.onerror = function (event) {
  console.error('æ•°æ®åˆ é™¤å¤±è´¥', event.target.error);
};
```

#### éå†æ•°æ®

ä½¿ç”¨ openCursor éå†å¯¹è±¡å­˜å‚¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼š

```js
const transaction = db.transaction(['users']);
const objectStore = transaction.objectStore('users');

objectStore.openCursor().onsuccess = function (event) {
  const cursor = event.target.result;
  if (cursor) {
    console.log('å½“å‰è®°å½•ï¼š', cursor.value);
    cursor.continue(); // ç»§ç»­éå†
  } else {
    console.log('éå†å®Œæˆ');
  }
};
```

### åŸºäºæ¡†æ¶

```
type BrushDatabaseProps = Dexie & {
  configs: EntityTable<{ key: string; value: any }, 'key'>;
};


  useEffect(() => {
    const _db = new Dexie('BrushDatabase') as BrushDatabaseProps;
    _db.version(1).stores({ configs: 'key' });
    _db.configs.get('histories').then(res => {
      if (res) {
        console.log(res.value);
      }
    });
    db.current = _db;
  }, []);
```

### å°è£…å®ç°

```javascript
class DB {
  /**
   * æ„é€ å™¨
   * @param {string} databaseName æ•°æ®åº“å
   * @param {number} version æ•°æ®åº“ç‰ˆæœ¬å·ï¼ˆä»…æ”¯æŒæ•´æ•°ï¼‰
   * @param {object} storeOptions é…ç½®é¡¹ { è¡¨åï¼šä¸»é”® }
   */
  constructor(databaseName, version, storeOptions) {
    // ç¼“å­˜æ•°æ®åº“ { [name + version]ï¼šdatabase }
    this._dbs = {};
    this._databaseName = databaseName;
    this.open(databaseName, version, storeOptions);
  }

  /**
   * æ‰“å¼€æ•°æ®åº“
   * @param {string} databaseName æ•°æ®åº“å
   * @param {number} version æ•°æ®åº“ç‰ˆæœ¬å·ï¼ˆä»…æ”¯æŒæ•´æ•°ï¼‰
   * @param {object} storeOptions é…ç½®é¡¹
   */
  open(databaseName, version, storeOptions) {
    return new Promise((resolve, reject) => {
      // -- æ£€æµ‹æ˜¯å¦æœ‰ç¼“å­˜ï¼Œå¦‚æœæœ‰ç¼“å­˜åˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–æ•°æ®åº“
      if (this._dbs[databaseName + version]) {
        resolve(this._dbs[databaseName + version]);
        return;
      }
      // -- æ‰“å¼€æ•°æ®åº“
      const request = indexedDB.open(databaseName, version);
      // -- äº‹ä»¶ç›‘å¬ï¼šç‰ˆæœ¬æ›´æ–°ï¼Œåˆ›å»ºæ–°çš„storeçš„æ—¶å€™
      request.onupgradeneeded = (event) => {
        console.log('ã€Indexed-DBã€‘ï¼šUpgrading...');
        // IDBDatabase
        const database = event.target.result;
        // ç¼“å­˜èµ·æ¥
        this._dbs[databaseName + version] = database;
        // éå†ä»“åº“é…ç½®é¡¹
        for (const key in storeOptions) {
          // åˆ¤æ–­æ˜¯å¦å­˜åœ¨ä»“åº“ï¼ˆè¡¨ï¼‰ï¼Œä¸å­˜åœ¨åˆ™æ–°å»º
          if (database.objectStoreNames.contains(key) === false) {
            const keyPath = storeOptions[key] ? storeOptions[key] : [];
            database.createObjectStore(key, { keyPath });
          }
        }
        resolve(database);
      };
      // -- äº‹ä»¶ç›‘å¬ï¼šæ•°æ®åº“æ‰“å¼€æˆåŠŸçš„å›è°ƒ
      request.onsuccess = (event) => {
        console.log('ã€Indexed-DBã€‘ï¼šopen success.');
        // IDBDatabase
        const database = event.target.result;
        // ç¼“å­˜èµ·æ¥
        this._dbs[databaseName + version] = database;
        resolve(database);
      };
      // -- äº‹ä»¶ç›‘å¬ï¼šæ•°æ®åº“æ‰“å¼€å¤±è´¥çš„å›è°ƒ
      request.onerror = (event) => {
        reject(event);
        console.error('ã€Indexed-DBã€‘ï¼š', event);
      };
    });
  }

  /**
   * è·å–äº‹åŠ¡
   * @param {*} storeName
   * @param {*} version
   * @returns
   */
  async _getTransaction(storeName, version) {
    let db;
    // å…ˆä»ç¼“å­˜è·å–
    if (this._dbs[this._databaseName + version]) {
      db = this._dbs[this._databaseName + version];
    } else {
      db = await this.open(this._databaseName, version);
    }
    return db.transaction([storeName], 'readwrite');
  }

  /**
   * è·å–store
   * objectStore: è¡¨ç¤ºå…è®¸è®¿é—®IndexedDBæ•°æ®åº“ä¸­çš„ä¸€ç»„æ•°æ®çš„å¯¹è±¡å­˜å‚¨ï¼Œ
   * @param {*} storeName
   * @param {*} version
   */
  async _getObjectStore(storeName, version) {
    const transaction = await this._getTransaction(storeName, version);
    return transaction.objectStore(storeName);
  }

  /**
   * è·å–ä¸€ä¸ªstore
   */
  collection(storeName, version) {
    this.currentStore = storeName;
    this._getObjectStore(storeName, version);
    return this;
  }

  /**
   * æŸ¥è¯¢æ•°æ®
   * @param {string | number} id
   * @returns
   */
  async get(id) {
    return new Promise(async (resolve, reject) => {
      const objectStore = await this._getObjectStore(this.currentStore);
      const request = objectStore.get(id);
      request.onsuccess = function (event) {
        resolve(event.target.result);
      };
      request.onerror = (event) => {
        reject(event);
      };
    });
  }
  /**
   * æ·»åŠ æ•°æ®
   * @param {object} data
   * @returns
   */
  async add(data) {
    return new Promise(async (resolve, reject) => {
      const objectStore = await this._getObjectStore(this.currentStore, 3);
      const request = objectStore.add(data);
      request.onsuccess = function (event) {
        resolve(event.target.result);
      };
      request.onerror = (event) => {
        reject(event);
      };
    });
  }
  /**
   * åˆ é™¤æ•°æ®
   * @param {string | number} id
   * @returns
   */
  async delete(id) {
    return new Promise(async (resolve, reject) => {
      const objectStore = await this._getObjectStore(this.currentStore);
      const request = objectStore.delete(id);
      request.onsuccess = function (event) {
        resolve(true);
      };
      request.onerror = (event) => {
        console.log('ã€Indexed-DBã€‘ï¼š', event);
        reject(false);
      };
    });
  }
  /**
   * æ›´æ–°æ•°æ®
   * æ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ä¼šæ–°å¢æ•°æ®
   * @param {*} data
   * @returns
   */
  async put(data) {
    console.log('Put...');
    return new Promise(async (resolve, reject) => {
      const objectStore = await this._getObjectStore(this.currentStore);
      const request = objectStore.put(data);
      request.onsuccess = function (event) {
        resolve(event.target.result);
      };
      request.onerror = (event) => {
        reject(event);
      };
    });
  }

  async clear(storeName) {
    return new Promise((resolve, reject) => {
      this._getObjectStore(this.currentStore).then((objectStore) => {
        const request = objectStore.clear(data);
        request.onsuccess = function (event) {
          resolve(event.target.result);
        };
        request.onerror = (event) => {
          reject(event);
        };
      });
    });
  }
  /**
   * éå†æ•°æ®
   * @returns
   */
  async each() {
    return new Promise(async (resolve, reject) => {
      const objectStore = await this._getObjectStore(this.currentStore);
      const request = objectStore.openCursor();
      const resp = [];
      request.onsuccess = function (event) {
        const cursor = event.target.result;
        if (cursor) {
          resp.push(cursor.value);
          cursor.continue();
        } else {
          resolve(resp);
        }
      };
      request.onerror = (event) => {
        reject(event);
      };
    });
  }
}

```

### ç»“å°¾

å¦‚æœç¢°åˆ°å‰ç«¯é¢‘ç¹å­˜å‚¨æ“ä½œæˆ–è€…å¤§æ–‡ä»¶ç¼“å­˜çš„éœ€æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨IndexedDBã€‚

å®é™…åº”ç”¨ä¸­ï¼Œæ¨èä½¿ç”¨ï¼š[dexie.js](https://dexie.org/) 

## ServiceWorker

[å‚è€ƒ >>](https://developer.mozilla.org/zh-CN/docs/Web/API/ServiceWorker)

## CacheStorage

[å‚è€ƒ >>](https://developer.mozilla.org/zh-CN/docs/Web/API/CacheStorage) 
